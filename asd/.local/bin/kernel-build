#!/usr/bin/env sh

[ "$(id -u)" != '0' ] && echo need su && exit

cd /usr/src/linux || exit

VER=$(grep -E '^CONFIG_LOCALVERSION' .config | sed s/'\(^[^"]*"\)\|"'//g)
DIR=/lib/modules/$(readlink "$PWD" | sed s/'linux-'//)$VER

[ "$1" = '-s' ] || make nconfig

if make -j4; then
    rm -rv "$DIR"
    make install modules_install
    cp -av arch/x86/boot/bzImage /boot/efi/EFI/gentoo/kernel.efi
fi
